<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字体使用检测工具</title>
    <style>
        /* 测试样式 */
        body {
            font-family: "Helvetica Neue", Arial, "PingFang SC", "Microsoft YaHei", sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        
        .title {
            font-family: "Custom Font", Georgia, "Songti SC", serif;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .content {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, sans-serif;
            margin-bottom: 30px;
        }
        
        .result-panel {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            border-left: 4px solid #ff6b6b;
        }
        
        .result-item.success {
            border-left-color: #51cf66;
        }
        
        .result-item.warning {
            border-left-color: #ffd43b;
        }
        
        .element-info {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        
        .font-info {
            margin-top: 8px;
        }
        
        .expected {
            color: #0066cc;
        }
        
        .actual {
            color: #cc0066;
            font-weight: bold;
        }
        
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        button:hover {
            background: #3182ce;
        }
        
        .stats {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1 class="title">字体使用检测工具</h1>
    
    <div class="content">
        <p>这是一段测试文本，用于检测字体渲染情况。This is a test paragraph with mixed English and 中文文字。</p>
        <p>第二段测试内容，包含更多的中文字符和English words。123456789</p>
    </div>
    
    <button onclick="checkFonts()">开始检测字体</button>
    
    <div id="results" class="result-panel" style="display: none;">
        <!-- 检测结果将显示在这里 -->
    </div>

    <script>
        /**
         * 字体检测工具
         * 检测页面元素实际使用的字体是否为CSS中设置的首选字体
         */
        function checkFonts() {
            const results = [];
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // 获取所有包含文本的元素
            const allElements = document.querySelectorAll('*');
            
            // 统计信息
            let totalChecked = 0;
            let usingPreferred = 0;
            let notUsingPreferred = 0;
            
            allElements.forEach(element => {
                // 跳过脚本、样式等不可见元素
                if (!element.textContent.trim() || 
                    element.tagName === 'SCRIPT' || 
                    element.tagName === 'STYLE' ||
                    element.id === 'results') {
                    return;
                }
                
                // 只检查直接包含文本的元素（不包括子元素的文本）
                const hasDirectText = Array.from(element.childNodes).some(
                    node => node.nodeType === Node.TEXT_NODE && node.textContent.trim()
                );
                
                if (!hasDirectText) {
                    return;
                }
                
                const computedStyle = window.getComputedStyle(element);
                const fontFamily = computedStyle.fontFamily;
                
                // 解析font-family列表
                const fontList = parseFontFamily(fontFamily);
                
                if (fontList.length === 0) {
                    return;
                }
                
                const preferredFont = fontList[0];
                
                // 获取实际渲染的字体
                const actualFont = detectActualFont(element, computedStyle);
                
                totalChecked++;
                
                // 判断是否使用了首选字体
                const isUsingPreferred = isFontMatch(actualFont, preferredFont);
                
                if (isUsingPreferred) {
                    usingPreferred++;
                } else {
                    notUsingPreferred++;
                }
                
                // 获取元素的文本预览
                const textPreview = element.textContent.trim().substring(0, 50);
                
                results.push({
                    element: element,
                    tagName: element.tagName.toLowerCase(),
                    className: element.className,
                    textPreview: textPreview + (element.textContent.trim().length > 50 ? '...' : ''),
                    preferredFont: preferredFont,
                    fontList: fontList,
                    actualFont: actualFont,
                    isUsingPreferred: isUsingPreferred
                });
            });
            
            // 显示结果
            displayResults(results, {
                total: totalChecked,
                usingPreferred: usingPreferred,
                notUsingPreferred: notUsingPreferred
            });
        }
        
        /**
         * 解析font-family字符串，提取字体列表
         */
        function parseFontFamily(fontFamily) {
            // 移除引号并分割
            return fontFamily
                .split(',')
                .map(font => font.trim().replace(/['"]/g, ''))
                .filter(font => font.length > 0);
        }
        
        /**
         * 检测元素实际使用的字体
         * 使用canvas测量方法
         */
        function detectActualFont(element, computedStyle) {
            const testText = getTestText(element.textContent);
            const fontSize = computedStyle.fontSize;
            const fontWeight = computedStyle.fontWeight;
            const fontStyle = computedStyle.fontStyle;
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // 获取font-family列表
            const fontList = parseFontFamily(computedStyle.fontFamily);
            
            // 创建基准字体测量（使用通用字体）
            const baselineFont = `${fontStyle} ${fontWeight} ${fontSize} monospace`;
            context.font = baselineFont;
            const baselineWidth = context.measureText(testText).width;
            
            // 测试每个字体
            for (let i = 0; i < fontList.length; i++) {
                const testFont = `${fontStyle} ${fontWeight} ${fontSize} "${fontList[i]}", monospace`;
                context.font = testFont;
                const testWidth = context.measureText(testText).width;
                
                // 如果宽度不同，说明字体可用
                if (Math.abs(testWidth - baselineWidth) > 0.1) {
                    return fontList[i];
                }
            }
            
            // 如果都没有匹配，返回最后一个兜底字体
            return fontList[fontList.length - 1] || 'unknown';
        }
        
        /**
         * 获取用于测试的文本
         * 优先使用元素中的实际文本
         */
        function getTestText(elementText) {
            const text = elementText.trim();
            if (text.length > 0) {
                // 取前20个字符作为测试文本
                return text.substring(0, 20);
            }
            // 默认测试文本（包含中英文）
            return 'ABCabc123中文测试';
        }
        
        /**
         * 判断两个字体名称是否匹配
         */
        function isFontMatch(actualFont, preferredFont) {
            // 标准化字体名称（小写，移除空格）
            const normalize = (font) => font.toLowerCase().replace(/\s+/g, '');
            return normalize(actualFont) === normalize(preferredFont);
        }
        
        /**
         * 显示检测结果
         */
        function displayResults(results, stats) {
            const resultsPanel = document.getElementById('results');
            resultsPanel.style.display = 'block';
            
            let html = `
                <div class="stats">
                    <div>检测元素总数: ${stats.total}</div>
                    <div style="color: #51cf66;">✓ 使用首选字体: ${stats.usingPreferred}</div>
                    <div style="color: #ff6b6b;">✗ 未使用首选字体: ${stats.notUsingPreferred}</div>
                </div>
            `;
            
            // 先显示未使用首选字体的元素
            const notUsing = results.filter(r => !r.isUsingPreferred);
            const using = results.filter(r => r.isUsingPreferred);
            
            if (notUsing.length > 0) {
                html += '<h3 style="color: #ff6b6b; margin-top: 0;">⚠️ 未使用首选字体的元素:</h3>';
                notUsing.forEach((result, index) => {
                    html += generateResultItem(result, index);
                });
            }
            
            if (using.length > 0) {
                html += '<h3 style="color: #51cf66; margin-top: 20px;">✓ 正常使用首选字体的元素:</h3>';
                using.forEach((result, index) => {
                    html += generateResultItem(result, index + notUsing.length);
                });
            }
            
            resultsPanel.innerHTML = html;
            
            // 添加点击高亮功能
            document.querySelectorAll('.result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const result = results[index];
                    highlightElement(result.element);
                });
            });
        }
        
        /**
         * 生成单个结果项的HTML
         */
        function generateResultItem(result, index) {
            const statusClass = result.isUsingPreferred ? 'success' : 'warning';
            const statusIcon = result.isUsingPreferred ? '✓' : '✗';
            
            return `
                <div class="result-item ${statusClass}" data-index="${index}" style="cursor: pointer;" title="点击高亮显示元素">
                    <div><strong>${statusIcon} ${result.tagName}${result.className ? '.' + result.className : ''}</strong></div>
                    <div style="margin-top: 5px; color: #333;">"${result.textPreview}"</div>
                    <div class="font-info">
                        <div>期望首选字体: <span class="expected">${result.preferredFont}</span></div>
                        <div>实际使用字体: <span class="actual">${result.actualFont}</span></div>
                        <div class="element-info">完整字体列表: ${result.fontList.join(', ')}</div>
                    </div>
                </div>
            `;
        }
        
        /**
         * 高亮显示元素
         */
        function highlightElement(element) {
            // 移除之前的高亮
            document.querySelectorAll('.temp-highlight').forEach(el => {
                el.classList.remove('temp-highlight');
            });
            
            // 添加高亮样式
            const style = document.createElement('style');
            style.textContent = `
                .temp-highlight {
                    outline: 3px solid #ff6b6b !important;
                    outline-offset: 2px;
                    background-color: rgba(255, 107, 107, 0.1) !important;
                }
            `;
            if (!document.querySelector('#highlight-style')) {
                style.id = 'highlight-style';
                document.head.appendChild(style);
            }
            
            element.classList.add('temp-highlight');
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // 3秒后移除高亮
            setTimeout(() => {
                element.classList.remove('temp-highlight');
            }, 3000);
        }
        
        // 页面加载完成后自动执行一次检测
        // window.addEventListener('load', checkFonts);
    </script>
</body>
</html>
